# HTTP Worker with Redis Streams - Docker Compose Setup
# 
# Quick start:
#   make up          - Start all services
#   make test        - Run test suite  
#   make down        - Stop all services
#
# See DOCKER.md for detailed guide

version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: zooza-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - zooza-network

  mysql:
    image: mysql:8.0
    container_name: zooza-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=zooza
      - MYSQL_USER=zooza
      - MYSQL_PASSWORD=zooza
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - zooza-network

  worker:
    build: ../
    container_name: zooza-worker
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    environment:
      - REDIS_HOST_PORT=redis:6379
      - METRICS_PORT=9000
      - DEFAULT_WORKER_URI=http://http-server:8000/events/[EVENT_TYPE]
      - DLQ_DB_CONNECTION=mysql+aiomysql://zooza:zooza@mysql:3306/zooza
      - DLQ_DB_TABLE=events
    ports:
      - "9000:9000"  # Prometheus metrics
    command: python worker.py
    networks:
      - zooza-network
    restart: unless-stopped

  http-server:
    build: .
    container_name: zooza-http-server
    environment:
      - REDIS_HOST_PORT=redis:6379
      - SERVER_PORT=8000
    ports:
      - "8000:8000"
    command: bash -c "while true; do sleep 1 && python test_http_server.py; done"
    networks:
      - zooza-network

  test:
    build: .
    container_name: zooza-test
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SERVER_PORT=8000
      - SERVER_HOST=http-server
      - NUM_EVENTS=500
      - DB_CONNECTION=mysql+aiomysql://zooza:zooza@mysql:3306/zooza
    command: >
      sh -c "sleep 1 && python test_event_generator.py"
    networks:
      - zooza-network

networks:
  zooza-network:
    driver: bridge

volumes:
  mysql-data:
